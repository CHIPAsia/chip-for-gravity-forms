name: WordPress Plugin Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # First tier: build-zip and php-compatibility run in parallel
  build-zip:
    name: Build Release Zip
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Prepare plugin folder
        run: |
          # Create a clean directory structure for the plugin
          # The folder name MUST match the plugin slug for WordPress
          mkdir -p dist/chip-for-gravity-forms
          git archive HEAD | tar -x -C dist/chip-for-gravity-forms
          echo "✅ Prepared plugin folder"
          ls -la dist/chip-for-gravity-forms/

      - name: Upload zip artifact
        uses: actions/upload-artifact@v6
        with:
          name: chip-for-gravity-forms
          path: dist/
          retention-days: 5

  php-compatibility:
    name: PHP ${{ matrix.php-version }} Compatibility
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.4']

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}

      - name: Install PHPCompatibility
        run: |
          composer global config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer global require --dev squizlabs/php_codesniffer dealerdirect/phpcodesniffer-composer-installer phpcompatibility/phpcompatibility-wp:"*"
          echo "$(composer global config bin-dir --absolute)" >> $GITHUB_PATH

      - name: Verify PHPCS Standards
        run: |
          phpcs -i

      - name: Check PHP ${{ matrix.php-version }} Compatibility
        run: |
          phpcs --standard=PHPCompatibilityWP --runtime-set testVersion ${{ matrix.php-version }} --extensions=php --ignore=vendor,node_modules,assets .

  # Second tier: phpcs runs after php-compatibility
  phpcs:
    name: PHP CodeSniffer (WordPress Standards)
    runs-on: ubuntu-latest
    needs: [php-compatibility]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'

      - name: Install WordPress Coding Standards
        run: |
          composer global config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer global require --dev squizlabs/php_codesniffer dealerdirect/phpcodesniffer-composer-installer wp-coding-standards/wpcs:"^3.0"
          echo "$(composer global config bin-dir --absolute)" >> $GITHUB_PATH

      - name: Verify PHPCS Standards
        run: |
          phpcs -i

      - name: Run PHPCS
        run: |
          phpcs --standard=phpcs.xml .
        continue-on-error: false

  # Third tier: plugin-check runs after phpcs
  plugin-check:
    name: Plugin Check
    runs-on: ubuntu-latest
    needs: [phpcs]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Prepare plugin directory
        run: |
          mkdir -p ./build/chip-for-gravity-forms
          git archive HEAD | tar -x -C ./build/chip-for-gravity-forms
          echo "✅ Prepared plugin folder"
          ls -la ./build/chip-for-gravity-forms/

      - name: Run Plugin Check
        uses: wordpress/plugin-check-action@v1
        with:
          build-dir: './build/chip-for-gravity-forms'
          exclude-directories: 'vendor,node_modules'
